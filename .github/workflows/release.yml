name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, curl

      - name: Verify vendor dependencies
        run: |
          # Check if vendor/fchub/license-sdks-php is a symlink (shouldn't be after sync-to-public.sh fix)
          if [ -L "vendor/fchub/license-sdks-php" ]; then
            echo "âŒ ERROR: vendor/fchub/license-sdks-php is still a symlink"
            echo "Run sync-to-public.sh to fix this before releasing"
            exit 1
          fi
          
          # Verify License_Manager.php exists
          if [ ! -f "vendor/fchub/license-sdks-php/src/License_Manager.php" ]; then
            echo "âŒ ERROR: License_Manager.php not found in vendor/fchub/license-sdks-php/src/"
            echo "Available vendor/fchub contents:"
            ls -la vendor/fchub/ 2>/dev/null || echo "vendor/fchub/ does not exist"
            exit 1
          fi
          
          # Verify other critical dependencies
          if [ ! -f "vendor/autoload.php" ]; then
            echo "âŒ ERROR: vendor/autoload.php not found"
            exit 1
          fi
          
          echo "âœ“ Vendor dependencies verified"

      - name: Create release ZIP
        run: |
          # Create temp directory
          mkdir -p /tmp/fchub-stream

          # Copy all files except .git and .github
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='fchub-stream-*.zip' \
            --exclude='fchub-stream.zip' \
            . /tmp/fchub-stream/
          
          # Verify vendor/ is included
          if [ ! -d "/tmp/fchub-stream/vendor" ]; then
            echo "âŒ ERROR: vendor/ directory not found in release package"
            exit 1
          fi
          
          # Verify License_Manager.php is in ZIP
          if [ ! -f "/tmp/fchub-stream/vendor/fchub/license-sdks-php/src/License_Manager.php" ]; then
            echo "âŒ ERROR: License_Manager.php not found in release package"
            exit 1
          fi
          
          echo "âœ“ Release package verified"

          # Create versioned ZIP
          cd /tmp
          zip -r fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip fchub-stream/

          # Verify ZIP structure (must contain fchub-stream/ folder)
          if ! unzip -l fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip | grep -q "fchub-stream/fchub-stream.php"; then
            echo "ERROR: ZIP structure incorrect - missing fchub-stream/ folder"
            exit 1
          fi

          echo "âœ“ ZIP structure verified: fchub-stream/ folder present"

          # Create latest ZIP (without version number)
          cp fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip fchub-stream.zip

          # Move to workspace
          mv fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip $GITHUB_WORKSPACE/
          mv fchub-stream.zip $GITHUB_WORKSPACE/

      - name: Extract changelog from CHANGELOG.md
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # Check if CHANGELOG.md exists
          if [ ! -f "CHANGELOG.md" ]; then
            echo "CHANGELOG=No changelog found. Built anyway. Check repo for details." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract changelog for this version from CHANGELOG.md
          # Looks for ## [VERSION] section and extracts until next ## [ or end of file
          CHANGELOG=$(awk -v version="$VERSION" '
            /^## \[/ {
              if (found) exit;
              if ($0 ~ "\\[" version "\\]") found=1;
              next;
            }
            found { print }
          ' CHANGELOG.md)

          # If no version-specific changelog found, use fallback
          if [ -z "$CHANGELOG" ]; then
            echo "CHANGELOG=Version $VERSION released. Check [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." >> $GITHUB_OUTPUT
          else
            # Save changelog to output
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: FCHub Stream v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## FCHub Stream v${{ steps.get_version.outputs.VERSION }}

            Video streaming for FluentCommunity. Built because WordPress media library and video don't mix.

            ### ðŸ“¥ Download

            - **Versioned**: `fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip`
            - **Latest** (always newest): `fchub-stream.zip`

            Both files identical. Pick one. Works.

            ### Installation

            1. Download ZIP (either one)
            2. WordPress Admin â†’ Plugins â†’ Add New â†’ Upload Plugin
            3. Upload â†’ Install â†’ Activate
            4. Done. No composer. No npm. Just works.

            **Updating?** Upload new ZIP. WordPress updates automatically. Won't duplicate.

            ### Requirements

            - WordPress 6.7+
            - PHP 8.3+
            - FluentCommunity (must be active)
            - Cloudflare Stream OR Bunny.net account

            ### Changes

            ${{ steps.changelog.outputs.CHANGELOG }}

            ---

            **Documentation**: https://docs.fchub.co/docs/fchub-stream

            **Part of FCHub Ecosystem**: https://fchub.co

            **Support Development**: [Donate via Stripe](https://donate.stripe.com/aFa00i5Ml01U1eKeO39Zm0G)

            _Building design systems nobody asked for but everyone secretly needs. Your $20 won't solve my problems, but it might cover electricity bills or buy the coffee that powers my 4am "this'll definitely work" commits._

            **Latest Download Link**:
            ```
            https://github.com/${{ github.repository }}/releases/latest/download/fchub-stream.zip
            ```

            Built out of media library trauma. Streams out of necessity.
          files: |
            fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip
            fchub-stream.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
