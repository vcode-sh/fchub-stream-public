name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release ZIP
        run: |
          # Create temp directory
          mkdir -p /tmp/fchub-stream

          # Copy all files except .git and .github
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='fchub-stream-*.zip' \
            --exclude='fchub-stream.zip' \
            . /tmp/fchub-stream/

          # Create versioned ZIP
          cd /tmp
          zip -r fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip fchub-stream/

          # Verify ZIP structure (must contain fchub-stream/ folder)
          if ! unzip -l fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip | grep -q "fchub-stream/fchub-stream.php"; then
            echo "ERROR: ZIP structure incorrect - missing fchub-stream/ folder"
            exit 1
          fi

          echo "âœ“ ZIP structure verified: fchub-stream/ folder present"

          # Create latest ZIP (without version number)
          cp fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip fchub-stream.zip

          # Move to workspace
          mv fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip $GITHUB_WORKSPACE/
          mv fchub-stream.zip $GITHUB_WORKSPACE/

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "CHANGELOG=Initial release" >> $GITHUB_OUTPUT
          else
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: FCHub Stream v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## FCHub Stream v${{ steps.get_version.outputs.VERSION }}

            Video streaming for FluentCommunity. Built because WordPress media library and video don't mix.

            ### ðŸ“¥ Download

            - **Versioned**: `fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip`
            - **Latest** (always newest): `fchub-stream.zip`

            Both files identical. Pick one. Works.

            ### Installation

            1. Download ZIP (either one)
            2. WordPress Admin â†’ Plugins â†’ Add New â†’ Upload Plugin
            3. Upload â†’ Install â†’ Activate
            4. Done. No composer. No npm. Just works.

            **Updating?** Upload new ZIP. WordPress updates automatically. Won't duplicate.

            ### Requirements

            - WordPress 6.7+
            - PHP 8.3+
            - FluentCommunity (must be active)
            - Cloudflare Stream OR Bunny.net account

            ### Changes

            ${{ steps.changelog.outputs.CHANGELOG }}

            ---

            **Documentation**: https://docs.fchub.co/docs/fchub-stream

            **Part of FCHub Ecosystem**: https://fchub.co

            **Support Development**: https://buymeacoffee.com/vcode

            **Latest Download Link**:
            ```
            https://github.com/${{ github.repository }}/releases/latest/download/fchub-stream.zip
            ```

            Built out of media library trauma. Streams out of necessity.
          files: |
            fchub-stream-${{ steps.get_version.outputs.VERSION }}.zip
            fchub-stream.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
